package com.atguigu.gmall.secskill.controller;import com.atguigu.gmall.secskill.util.RedisUtil;import org.redisson.api.RLock;import org.redisson.api.RedissonClient;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Controller;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.ResponseBody;import redis.clients.jedis.Jedis;import redis.clients.jedis.Transaction;import java.math.BigDecimal;import java.util.List;/** * @ClassName SecKillController * @Author 19680 * @Date 2020/2/19 14:47 * @Version 1.0 * @Description TODO **/@Controllerpublic class SecKillController {    @Autowired    RedisUtil redisUtil;    @Autowired    RedissonClient redissonClient;    @RequestMapping("seckill/two")    @ResponseBody    public String skillOne(String sku) {        sku = "130";        Jedis jedis = redisUtil.getJedis();        String key = "sku:" + sku + ":secskill";        String stock = jedis.get(key);        try {            if (stock != null) {                BigDecimal bigDecimal = new BigDecimal(stock + "");                int compare = bigDecimal.compareTo(new BigDecimal("0"));                if (compare > 0) {                    jedis.watch(key);                    Transaction multi = jedis.multi();                    multi.incrBy(key, -1);                    List<Object> exec = multi.exec();                    if (exec != null || exec.size() > 0) {                        System.err.println("抢购成功，库存还剩余：" + exec.get(0));                        jedis.set("userId:25:secskill", "1", "nx", "px", 1000 * 60 * 20);                        return "抢购成功，库存还剩余：" + exec.get(0);                    } else {                        System.err.println("抢购失败！！！");                        return "抢购失败！！！";                    }                }            } else {                System.err.println("抢购已结束！！！");                return "抢购已结束！！！";            }        } finally {            jedis.close();        }        return "404";    }    @ResponseBody    @RequestMapping("seckill/One")    public String skillTwo(String sku) {        String key = "sku:" + sku + ":secskill";        Jedis jedis = redisUtil.getJedis();        String stock = jedis.get(key);        if (stock != null) {            RLock lock = redissonClient.getLock("lock");            try {                BigDecimal bigDecimal = new BigDecimal(stock);                int compare = bigDecimal.compareTo(new BigDecimal(0));                if (compare > 0) {                    lock.lock();                    BigDecimal subtract = bigDecimal.subtract(new BigDecimal("1")); // bigDecimal.subtract():减                    Long aLong = jedis.incrBy(key, -1);                    System.err.println("抢购成功，库存还剩余：" + aLong);                    // 发送消息队列，根据sku和userId减库存                    return "抢购成功，库存还剩余：" + aLong;                } else {                    System.err.println("抢购失败！！！");                }            } finally {                lock.unlock();            }        }        jedis.close();        return "404";    }}