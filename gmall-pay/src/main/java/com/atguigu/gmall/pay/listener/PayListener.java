package com.atguigu.gmall.pay.listener;import com.atguigu.gmall.bean.PaymentInfo;import com.atguigu.gmall.pay.constant.PayStatus;import com.atguigu.gmall.service.PayInfoService;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.jms.annotation.JmsListener;import org.springframework.stereotype.Component;import javax.jms.JMSException;import javax.jms.MapMessage;/** * @ClassName PayListener * @Author 19680 * @Date 2020/2/17 22:35 * @Version 1.0 * @Description TODO **/@Componentpublic class PayListener {    @Autowired    PayInfoService payInfoService;    @JmsListener(containerFactory = "jmsQueueListener", destination = "PAY_RESULT_CHECK_QUEUE")    public void payConsumer(MapMessage mapMessage){        try {            String out_trade_no = mapMessage.getString("out_trade_no");            long count = mapMessage.getLong("count");            String status = payInfoService.checkPayStatus(out_trade_no);            PaymentInfo paymentInfo = new PaymentInfo();            if (status == null || PayStatus.WAIT_BUYER_PAY.equals(status)){                if (count <= 7){                    paymentInfo.setOrderSn(out_trade_no);                    payInfoService.checkPayResultStatus(paymentInfo,count);                    count ++ ;                    System.err.println("延时队列查询订单：" + out_trade_no + "，第" + count + "次");                }else {                    paymentInfo.setPaymentStatus("未支付");                    payInfoService.sendPaymentQueue(paymentInfo);                }            }else {                if (PayStatus.TRADE_CLOSED.equals(status)) {                    paymentInfo.setPaymentStatus("未付款");                }                if (PayStatus.TRADE_FINISHED.equals(status)) {                    paymentInfo.setPaymentStatus("已关闭");                }                if (PayStatus.TRADE_SUCCESS.equals(status)) {                    paymentInfo.setPaymentStatus("已支付");                }                payInfoService.sendPaymentQueue(paymentInfo);            }        } catch (JMSException e) {            e.printStackTrace();        }    }}